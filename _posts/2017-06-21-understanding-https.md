---
layout: post
title: 认识 Https
category: js
---

### 参考资料

1. [HTTPS为什么安全 &分析 HTTPS 连接建立全过程](http://wetest.qq.com/lab/view/110.html)
1. [浏览器如何验证HTTPS证书的合法性？](https://www.zhihu.com/question/37370216)
1. [iOS 中对 HTTPS 证书链的验证](http://www.jianshu.com/p/31bcddf44b8d)
1. [安全套接字层：了解更多关于SSL验证及类型](http://blog.comodo.cn/understanding-ssl/)
1. [Https 详解](http://luojinping.com/2016/04/17/https详解/)

### 涉及的算法知识
1. 非对称加密算法（公钥私钥加密）：RSA，DSA/DSS，公钥和私钥一一对应，都只有一个
1. 对称加密算法：AES，RC4，3DES
1. 散列算法（HASH 算法）：MD5，SHA1，SHA256

### Http 为什么不安全？

Http 协议属于明文传输协议，交互过程以及数据传输都没有进行加密。而服务器和客户端的通讯是需要经过多个网络节点的，cmd 下用命令 tracert www.163.com 可以查看经过了哪几个节点。在这每一个节点上假如有“中间人”，他就可以查看甚至篡改通讯的数据。

可以把 Http 通信比喻成寄送信件一样，A 给 B 寄信，信件在寄送过程中，会经过很多的邮递员之手，他们可以拆开信读取里面的内容（因为 Http 是明文传输的）。A 的信件里面的任何内容（包括各类账号和密码）都会被轻易窃取。除此之外，邮递员们还可以伪造或者修改信件的内容，导致 B 接收到的信件内容是假的。

常见的“中间人”威胁案例如下：

1. 获取用户登录 XX 网站的账号密码，或者银行卡账号等等信息；
1. “中间人”将广告链接嵌入到服务器发给用户的 Http 报文里，用户打开网站会出现本不该存在的广告；
1. 修改 Http 请求的 response 为3xx重定向，用户的请求被劫持到另外一个网站，导致用户得不到正确的服务。
1. SSL剥离攻击：它的前提是用户很少直接在地址栏输入https://，用户总是通过点击链接或3xx重定向，从HTTP页面进入HTTPS页面。所以攻击者可以在用户访问HTTP页面时替换所有https://开头的链接为http://，达到阻止HTTPS的目的。

### Https 如何保证安全？

要解决 Http 带来的问题，就要引入加密以及身份验证机制。

如果服务器给客户端的消息是密文的，只有服务器和客户端才能读懂，就可以保证数据的保密性。同时，在交换数据之前，验证一下对方的合法身份，就可以保证通信双方的安全。这时服务器必须要把加密的密钥告诉客户端，客户端才能利用对称密钥解开密文的内容。但是，服务器如果将这个对称密钥以明文的方式给客户端，还是会被中间人截获，中间人也会知道对称密钥，依然无法保证通信的保密性。

这时，我们引入了非对称加解密的概念。在非对称加解密算法里，公钥加密的数据，有且只有唯一的私钥才能够解密，所以服务器只要把公钥发给客户端，客户端就可以用这个公钥来加密进行数据传输的对称密钥。客户端利用公钥将对称密钥发给服务器时，即使中间人截取了信息，他没有服务器的私钥也无法解密，因为私钥只部署在服务器，其他任何人都没有私钥，因此，只有服务器才能够解密。服务器拿到客户端的信息并用私钥解密之后，就可以拿到加解密数据用的对称密钥，通过这个对称密钥来进行后续通信的数据加解密。如图：
![](/static/image/20170622_1.png)

但是还是不能避免“中间人”劫持，过程如下图：
![](/static/image/20170622_2.png)

怎么解决这个问题呢，只要保证了最开始的时候公钥没有被“中间人”偷梁换柱就好了。可以引用权威的第三方的电子认证机构（即 CA）来保证公钥一定是服务器给客户端的。CA 会签发服务器的公钥，表示公钥是经过 CA 认证了的。这个已签发的公钥就被成为是“数字证书”，里面包含服务器的公钥和 CA 私钥加密的签名（还包括其他东西，这里就不展开讲了）。这样服务器发送给客户端的公钥就变成了签名了的数字证书，客户端用 CA 的自签名数字证书（里面有 CA 的公钥）来验证数字证书是否是 CA 签发的，验证的过程其实就是用公钥解密签名。这里需要说明的是：顶级 CA 自签名的数字证书是预置在操作系统里面的。

### 衍生知识

1. 一个疑问：公钥得到 CA 的认证后，为什么不直接用公钥传输数据，私钥解密数据？这个待考究。
1. 不要随便向电脑导入不明来历的证书，因为如果证书是来自“中间人”或者此证书所在的证书链已被污染，就存在危险。
1. 证书类型分为域验证（DV）、组织验证（OV）、扩展验证（EV），可以参考这个文章：[关于 SSL 验证及类型](http://blog.comodo.cn/understanding-ssl/)。
1. 国际互联网工程组织 IETE 正在推行一种新的Web安全协议 HTTP Strict Transport Security（HSTS）。比如，https://xxx 的响应头含有Strict-Transport-Security: max-age=31536000; includeSubDomains。这意味着两点：一是在接下来的一年中，浏览器只要向 xxx 或其子域名发送 HTTP 请求时，必须采用 HTTPS 来发起连接。比如，用户点击超链接或在地址栏输入 http://xxx/ ，浏览器应当自动将 http 转写成 https，然后直接向 https://xxx/ 发送请求。二是在接下来的一年中，如果 xxx 服务器发送的 TLS 证书无效，用户不能忽略浏览器警告继续访问网站。HSTS 可以用来抵御 SSL 剥离攻击。
1. Https 只是解决数据传输安全问题，并不是根治“中间人威胁”的方案。
1. 开启 Https 后由于多了证书验证的步骤，会比纯 Http 的站点慢。除了服务器优化方案之外，还可以让网站向 HTTP/2 靠齐。目前 HTTP/2 标准还在持续发生变化。它从 SPDY 演化为 HTTP/2，从 NPN 演化为 ALPN。对 HTTP/2 标准演变过程感兴趣的话可以看这一篇文章：[为什么我们应该尽快支持 ALPN？](https://imququ.com/post/enable-alpn-asap.html)。
1. 为了 Https 光是申请了一个证书就能保证网站的安全了么？并不是这样的，服务器配置不当反而会增加网站的危险性，例如 14 年 OpenSSL 爆发的心脏出血漏洞。用这个网站可以检测你的 Https 站点是否标准：[SSL Server Test](https://www.ssllabs.com/ssltest/analyze.html)。
1. 配置 Https 服务器的时候，服务器如果只返回自己的证书可能会被浏览器拒绝，最好是附带上整个证书链的证书。可以参考：[SSL 证书链不完整问题：中间证书果然是个坑](http://blog.sina.com.cn/s/blog_53ed87c10102vn8b.html)、[SSL证书的证书链文件使用的重要性](https://angeltime.cc/archives/643.html)、[证书链及在nginx下的配置](http://blog.hesey.net/2012/02/certificate-chain-and-configuration-of-nginx.html)。
1. 为什么百度、google 这种公司也需要向第三方购买签名证书？，因为自签 root 证书推广起来非常困难，这也导致目前的证书市场基本上被 Symantec (VeriSign / GeoTrust) / Comodo / GoDaddy 垄断。百度使用的是 VerSign，google 使用的是 GeoTrust。
1. 像安卓 IOS 其实可以用自签名证书来实现 Https 连接，参考：[iOS 中对 HTTPS 证书链的验证](http://www.jianshu.com/p/31bcddf44b8d)。

